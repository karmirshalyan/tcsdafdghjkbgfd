<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Spotify Now Playing</title>
<style>
    body {
        margin: 0;
        padding: 0;
        font-family: 'Nunito', sans-serif;
        overflow: hidden;
        background: #000;
        color: white;
        min-height: 100vh; 
        display: flex; 
        align-items: center;
        justify-content: center;
        position: relative; 
    }

    #blur-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-size: cover;
        background-position: center;
        filter: blur(40px) brightness(0.4);
        z-index: -1;
        transform: scale(1.2);
        transition: background-image 0.5s ease;
    }

    #vinyl-container {
        position: relative; 
        width: min(500px, 90vmin);
        height: min(500px, 90vmin);
        border-radius: 50%;
        background: radial-gradient(#111 0%, #000 60%, #000 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        z-index: 2;
    }

    #albumImage {
        width: 84%;
        height: 84%;
        border-radius: 50%;
        object-fit: cover;
        transition: opacity 0.4s ease;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .spinning {
        animation: spin 12s linear infinite;
    }

    .paused {
        animation-play-state: paused;
    }
    
    #song-info {
        position: absolute;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
        font-size: 28px;
        font-weight: 700;
        z-index: 3;
        width: 90%;
        max-width: 600px;
        word-wrap: break-word;
    }

    #artistName {
        font-size: 20px;
        opacity: 0.7;
        margin-top: 4px;
    }

    .lyric-floating {
        position: absolute;
        font-size: 22px;
        opacity: 0;
        white-space: nowrap;
        pointer-events: none;
        color: #fff;
        text-shadow: 0 0 5px #fff;
        z-index: 1;
        transition: all 1s ease;
    }

    .lyric-active {
        opacity: 1 !important;
        transform: scale(1.3);
        text-shadow: 0 0 25px #fff;
    }

    /* Стили для модального окна аутентификации */
    #auth-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    #auth-content {
        background: #1e1e1e;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    #auth-content h2 {
        margin-top: 0;
        margin-bottom: 20px;
        color: #1DB954;
    }

    .auth-option {
        background: #2d2d2d;
        border: none;
        color: white;
        padding: 15px 20px;
        margin: 10px 0;
        border-radius: 8px;
        width: 100%;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
    }

    .auth-option:hover {
        background: #3d3d3d;
    }

    #spotify-code-input {
        display: none;
        margin-top: 20px;
    }

    #access-code {
        width: 100%;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #444;
        background: #2d2d2d;
        color: white;
        margin-bottom: 10px;
        box-sizing: border-box;
    }

    #submit-code {
        background: #1DB954;
        border: none;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        cursor: pointer;
        width: 100%;
        font-size: 16px;
    }

    #submit-code:hover {
        background: #1ed760;
    }

    .info-text {
        font-size: 14px;
        opacity: 0.7;
        margin-top: 15px;
        line-height: 1.4;
    }

    .info-text a {
        color: #1DB954;
        text-decoration: none;
    }

    .info-text a:hover {
        text-decoration: underline;
    }

    .loading {
        opacity: 0.7;
        pointer-events: none;
    }
</style>
</head>
<body>

<div id="blur-bg"></div>

<div id="vinyl-container">
    <img id="albumImage" src="" />
</div>

<div id="song-info">
    <div id="trackName">Track</div>
    <div id="artistName">Artist</div>
</div>

<!-- Модальное окно выбора способа аутентификации -->
<div id="auth-modal">
    <div id="auth-content">
        <h2>Выберите способ аутентификации</h2>
        <button class="auth-option" id="pkce-auth">Войти через PKCE (рекомендуется)</button>
        <button class="auth-option" id="spotify-code-auth">Войти через Spotify Access Code</button>
        
        <div id="spotify-code-input">
            <input type="text" id="access-code" placeholder="Введите Spotify Access Code">
            <button id="submit-code">Подтвердить</button>
            <div class="info-text">
                Получите код на: 
                <a href="https://spotify-refresh-token-generator.netlify.app/" target="_blank">
                    spotify-refresh-token-generator.netlify.app
                </a>
            </div>
        </div>
    </div>
</div>

<script>
const client_id = "ca2b2a8fbe6c4adf9357b81a525ca490";
const redirect_uri = "https://karmirshalyan.github.io/spotifynowplaying/";
const scopes = ["user-read-currently-playing", "user-read-playback-state", "streaming"];

let token = null;
let currentAlbum = '';
let lyrics = [];
let playbackStartTime = 0;
let duration = 0;
let isPaused = false;
let lastTrackId = ""; 

// ===================== AUTH FUNCTIONS =====================
function generateRandomString(length) {
    let text = "";
    const possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    for (let i = 0; i < length; i++) {
        text += possible.charAt(Math.floor(Math.random() * possible.length));
    }
    return text;
}

async function sha256(plain) {
    const encoder = new TextEncoder();
    const data = encoder.encode(plain);
    const hash = await crypto.subtle.digest("SHA-256", data);
    return btoa(String.fromCharCode(...new Uint8Array(hash)))
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=+$/, "");
}

function saveVerifier(v) { localStorage.setItem("code_verifier", v); }
function loadVerifier() { return localStorage.getItem("code_verifier"); }

async function startAuth() {
    const codeVerifier = generateRandomString(64);
    saveVerifier(codeVerifier);
    const codeChallenge = await sha256(codeVerifier);

    const authUrl =
        "https://accounts.spotify.com/authorize" +
        `?client_id=${client_id}` +
        `&response_type=code` +
        `&redirect_uri=${encodeURIComponent(redirect_uri)}` +
        `&scope=${encodeURIComponent(scopes.join(" "))}` +
        `&code_challenge_method=S256` +
        `&code_challenge=${codeChallenge}`;

    window.location = authUrl;
}

async function requestAccessToken(code) {
    const code_verifier = loadVerifier();
    const body = new URLSearchParams({
        client_id,
        grant_type: "authorization_code",
        code,
        redirect_uri,
        code_verifier
    });

    const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
    });

    return await res.json();
}

async function refreshToken(refresh_token) {
    const body = new URLSearchParams({
        client_id,
        grant_type: "refresh_token",
        refresh_token
    });

    const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
    });

    return await res.json();
}

async function handleAuth() {
    const params = new URLSearchParams(window.location.search);

    if (params.get("code")) {
        // Обработка PKCE потока
        const code = params.get("code");
        const tokenData = await requestAccessToken(code);

        if (tokenData.access_token) {
            localStorage.setItem("access_token", tokenData.access_token);
            localStorage.setItem("refresh_token", tokenData.refresh_token);
            window.history.replaceState({}, document.title, redirect_uri);
            return tokenData.access_token;
        } else {
            console.error("Ошибка PKCE аутентификации:", tokenData);
            showAuthModal();
            return null;
        }
    }

    const stored = localStorage.getItem("access_token");
    if (stored) return stored;

    // Если нет токена, показываем модальное окно
    showAuthModal();
    return null;
}

// Функция для обработки Spotify Access Code через внешний сервис
async function handleSpotifyAccessCode(code) {
    try {
        // Показываем состояние загрузки
        const submitBtn = document.getElementById('submit-code');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Загрузка...';
        submitBtn.classList.add('loading');

        // Используем внешний сервис для получения токена
        const response = await fetch("https://spotify-refresh-token-generator.netlify.app/.netlify/functions/token", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                code: code
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const tokenData = await response.json();
        
        if (tokenData.access_token) {
            localStorage.setItem("access_token", tokenData.access_token);
            localStorage.setItem("refresh_token", tokenData.refresh_token);
            hideAuthModal();
            return tokenData.access_token;
        } else {
            throw new Error("Не удалось получить токен из ответа");
        }
    } catch (error) {
        console.error("Ошибка при получении токена через внешний сервис:", error);
        
        // Пробуем альтернативный метод - прямой запрос к Spotify
        try {
            console.log("Пробуем прямой метод...");
            return await handleSpotifyAccessCodeDirect(code);
        } catch (directError) {
            console.error("Ошибка при прямом методе:", directError);
            alert("Ошибка при получении токена. Проверьте правильность кода и попробуйте снова. Ошибка: " + error.message);
            return null;
        }
    } finally {
        // Восстанавливаем кнопку
        const submitBtn = document.getElementById('submit-code');
        submitBtn.textContent = 'Подтвердить';
        submitBtn.classList.remove('loading');
    }
}

// Альтернативный метод - прямой запрос к Spotify (для кодов, полученных другим способом)
async function handleSpotifyAccessCodeDirect(code) {
    const body = new URLSearchParams({
        grant_type: "authorization_code",
        code: code,
        redirect_uri: redirect_uri,
        client_id: client_id
        // client_secret не используется в PKCE flow
    });

    const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { 
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: body
    });

    const tokenData = await res.json();

    if (tokenData.access_token) {
        localStorage.setItem("access_token", tokenData.access_token);
        localStorage.setItem("refresh_token", tokenData.refresh_token);
        hideAuthModal();
        return tokenData.access_token;
    } else {
        throw new Error(tokenData.error_description || "Не удалось получить токен");
    }
}

// Функции для работы с модальным окном
function showAuthModal() {
    document.getElementById('auth-modal').style.display = 'flex';
}

function hideAuthModal() {
    document.getElementById('auth-modal').style.display = 'none';
}

// Обработчики событий для кнопок аутентификации
document.getElementById('pkce-auth').addEventListener('click', function() {
    startAuth();
});

document.getElementById('spotify-code-auth').addEventListener('click', function() {
    document.getElementById('spotify-code-input').style.display = 'block';
});

document.getElementById('submit-code').addEventListener('click', async function() {
    const code = document.getElementById('access-code').value.trim();
    if (code) {
        const token = await handleSpotifyAccessCode(code);
        if (token) {
            initPlayer();
        }
    } else {
        alert("Пожалуйста, введите Spotify Access Code");
    }
});

// Также разрешаем отправку по нажатию Enter
document.getElementById('access-code').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('submit-code').click();
    }
});

async function getValidToken() {
    let token = localStorage.getItem("access_token");
    const refresh_token = localStorage.getItem("refresh_token");

    if (!token) {
        token = await handleAuth();
        if (!token) return null;
    }

    // Проверяем валидность токена
    const test = await fetch("https://api.spotify.com/v1/me", {
        headers: { Authorization: "Bearer " + token }
    });

    if (test.status === 401 && refresh_token) {
        try {
            const newTok = await refreshToken(refresh_token);
            localStorage.setItem("access_token", newTok.access_token);
            if (newTok.refresh_token) localStorage.setItem("refresh_token", newTok.refresh_token);
            return newTok.access_token;
        } catch (error) {
            console.error("Ошибка обновления токена:", error);
            // Если не удалось обновить токен, запускаем аутентификацию заново
            localStorage.removeItem("access_token");
            localStorage.removeItem("refresh_token");
            showAuthModal();
            return null;
        }
    }

    return token;
}

// ===================== LYRICS FUNCTIONS =====================
function clearLyrics() {
    const old = document.querySelectorAll('.lyric-floating');
    old.forEach(el => el.remove());
}

function scatterLyrics() {
    clearLyrics();

    lyrics.forEach((line, index) => {
        const span = document.createElement("div");
        span.className = "lyric-floating";
        span.id = `lyric-${index}`;
        span.textContent = line.text;

        const screenWidth = window.innerWidth;
        const screenHeight = window.innerHeight;
        let x, y;
        do {
            x = Math.random() * screenWidth;
            y = Math.random() * screenHeight;
            const dx = x - screenWidth/2;
            const dy = y - screenHeight/2;
            var distance = Math.sqrt(dx*dx + dy*dy);
        } while(distance < 180);

        span.style.left = x + "px";
        span.style.top = y + "px";
        span.style.opacity = 0;

        document.body.appendChild(span);

        setTimeout(() => {
            span.style.opacity = 0.12;
        }, 100 * index);
    });
}

function highlightLyric(currentIndex) {
    document.querySelectorAll('.lyric-floating').forEach(el => el.classList.remove('lyric-active'));
    const active = document.getElementById(`lyric-${currentIndex}`);
    if(active) active.classList.add('lyric-active');
}

function parseLRC(lrc) {
    const lines = lrc.split("\n");
    return lines.map(line => {
        const t = line.match(/\[(\d{2}):(\d{2}\.\d{2})]/);
        if(!t) return null;
        return {
            time: parseInt(t[1])*60 + parseFloat(t[2]),
            text: line.replace(/\[.*?]/g,'').trim()
        };
    }).filter(x => x);
}

function updateLyrics() {
    if(!lyrics.length) return;
    const now = (Date.now() - playbackStartTime)/1000;
    const idx = lyrics.findIndex(l => l.time > now) - 1;
    if(idx >= 0) highlightLyric(idx);
}

function fetchLyrics(track, artist, album, duration){
    const url = `https://lrclib.net/api/get?track_name=${encodeURIComponent(track)}&artist_name=${encodeURIComponent(artist)}&album_name=${encodeURIComponent(album)}&duration=${duration}`;
    fetch(url)
    .then(r=>r.json())
    .then(data=>{
        if(!data.syncedLyrics) return;
        lyrics = parseLRC(data.syncedLyrics);
        scatterLyrics();
    })
    .catch(e=>console.log(e));
}

// ===================== PLAYER =====================
async function initPlayer() {
    token = await getValidToken();
    // Если токен получен, скрываем модальное окно и запускаем плеер
    if (token) {
        hideAuthModal();
        setInterval(() => fetchSong(token), 1500);
        setInterval(updateLyrics, 500);
    }
}

// Проверяем, есть ли уже токен при загрузке страницы
window.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem("access_token");
    const params = new URLSearchParams(window.location.search);
    
    // Если есть код в URL (возврат от PKCE аутентификации)
    if (params.get("code")) {
        initPlayer();
    } 
    // Если токен уже сохранен
    else if (token) {
        initPlayer();
    } 
    // Если ничего нет, показываем модальное окно
    else {
        showAuthModal();
    }
});

function fetchSong(token) {
    fetch('https://api.spotify.com/v1/me/player/currently-playing', {
        headers: { 'Authorization': 'Bearer ' + token }
    })
    .then(res => {
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
    })
    .then(data => {
        if(!data || !data.item) {
            clearLyrics();
            lastTrackId = "";
            document.getElementById('trackName').textContent = "Нет активного трека";
            document.getElementById('artistName').textContent = "Воспроизведите музыку в Spotify";
            return;
        }

        const track = data.item;

        // Если трек сменился
        if(track.id !== lastTrackId) {
            lastTrackId = track.id;
            clearLyrics();
            lyrics = [];
            
            document.getElementById('trackName').textContent = track.name;
            document.getElementById('artistName').textContent = track.artists.map(a => a.name).join(', ');
            
            fetchLyrics(track.name, track.artists[0].name, track.album.name, track.duration_ms / 1000);
        }

        duration = track.duration_ms / 1000;
        playbackStartTime = Date.now() - data.progress_ms;
        isPaused = !data.is_playing;

        const cover = track.album.images[0].url;
        if(cover !== currentAlbum) {
            currentAlbum = cover;
            const albumImg = document.getElementById('albumImage');
            albumImg.style.opacity = 0;
            setTimeout(() => {
                albumImg.src = cover;
                albumImg.style.opacity = 1;
                document.getElementById('blur-bg').style.backgroundImage = `url(${cover})`;
            }, 300);
        }

        updateRotation();
    })
    .catch(e => {
        console.log("Ошибка получения данных:", e);
        if (e.message.includes('401')) {
            // Токен невалиден, запускаем аутентификацию заново
            localStorage.removeItem("access_token");
            localStorage.removeItem("refresh_token");
            showAuthModal();
        }
    });
}

// ===================== ROTATION =====================
function updateRotation() {
    const vinyl = document.getElementById('vinyl-container');
    if(!isPaused){
        vinyl.classList.add('spinning');
        vinyl.classList.remove('paused');
    } else {
        vinyl.classList.add('paused');
    }
}
</script>

</body>
</html>
